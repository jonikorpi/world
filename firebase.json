{
  "rules": {

    "motd": {
      ".read": "auth != null",
      ".write": "auth.worldmaster === true",
      ".validate": "newData.isString()",
    },

    "tiles": {
      ".write": "auth.worldmaster === true",
      "$x": {
        "$y": {
          "$z": {
            ".read": "auth != null", /* TODO complicated neighbour rules */
            "influence": {
              "$playerID": { ".validate": "newData.isBoolean()" },
            },
            "object": {
              "owner": { ".validate": "newData.isString()" },
              "ID":    { ".validate": "newData.isString() || !newData.exists()" }, /*blank if stealthed*/
              "$other": { ".validate": "false" },
            },
            "tile": {
              "rock":  { ".validate": "newData.isNumber()" },
              "heat":  { ".validate": "newData.isNumber()" },
              "water": { ".validate": "newData.isNumber()" },
              "flora": { ".validate": "newData.isNumber()" },
              "$other": { ".validate": "false" },
            },
            "$other": { ".validate": "false" },
          },
        },
      },
    },

    "publicPlayers": {
      "$playerID": {
        ".read": "auth != null",
        ".write": "
             (auth != null && auth.uid === $playerID && !data.exists())
          || auth.worldmaster === true
        ",
        /* TODO public identifying features */
        "$other": { ".validate": "false" },
      },
    },

    "privatePlayers": {
      ".write": "auth.worldmaster === true",
      "$playerID": {
        ".read": "
             (auth != null && auth.uid === $playerID)
          || auth.worldmaster === true
        ",
        "objects": {
          "$objectID": { ".validate": "newData.isBoolean()" },
        },
        "cards": {
          "$cardID": {
            "type":   { ".validate": "newData.isString()" },
            "amount": { ".validate": "newData.isNumber()" },
            "$other": { ".validate": "false" },
          },
        },
        "inGame": { ".validate": "newData.isBoolean()" },
        "message": { ".validate": "newData.isString()" },
        "$other": { ".validate": "false" },
      },
    },

    "objects": {
      ".write": "auth.worldmaster === true",
      "$ownerID": {
        "$objectID": {
          ".read": "auth != null",
          "loc": {
            "x": { ".validate": "newData.isNumber()" },
            "y": { ".validate": "newData.isNumber()" },
            "z": { ".validate": "newData.isNumber()" },
            "$other": { ".validate": "false" },
          },
          "lastLoc": {
            "x": { ".validate": "newData.isNumber()" },
            "y": { ".validate": "newData.isNumber()" },
            "z": { ".validate": "newData.isNumber()" },
            "$other": { ".validate": "false" },
          },
          "type":   { ".validate": "newData.isString()" },
          "health": { ".validate": "newData.isNumber()" },
          "attack": { ".validate": "newData.isNumber()" },
          "$other": { ".validate": "false" },
        },
      }
    },

    "worldmasters": {
      ".read": "true",
      ".write": "auth.worldmaster === true",
      "$worldmasterID": {
        ".validate": "newData.isBoolean()",
      },
    },

    "actionQueue": {
      ".read": "auth.worldmaster === true",
      "tasks": {
        ".indexOn": "_state",

        "$taskId": {
          ".write": " (auth.uid != null && !data.exists()) || auth.worldmaster === true",
          ".validate": "
            newData.hasChildren(['request'])
            || (
              auth.worldmaster === true
              && newData.hasChildren(['_state', '_state_changed', '_progress'])
            )
          ",

          "request": {
            ".validate": "newData.hasChildren(['playerID', 'gameID', 'action', 'time']) || auth.worldmaster === true",
            "playerID": { ".validate": "newData.val() === auth.uid || auth.worldmaster === true", },
            "gameID": { ".validate": "root.child('games').hasChild(newData.val())", },
            "action": { ".validate": "newData.isString()" },
            "time":   { ".validate": "newData.val() === now || auth.worldmaster === true" },
            "$other": { ".validate": "false" },
          },

          "_state": {
            ".validate": "newData.isString()"
          },
          "_state_changed": {
            ".validate": "newData.isNumber() && (newData.val() === now
                          || data.val() === newData.val())"
          },
          "_owner": {
            ".validate": "newData.isString()"
          },
          "_progress": {
            ".validate": "newData.isNumber()
                          && newData.val() >= 0
                          && newData.val() <= 100"
          },
          "_error_details": {
              "error": {
                ".validate": "newData.isString()"
              },
              "error_stack": {
                ".validate": "newData.isString()"
              },
              "previous_state": {
                ".validate": "newData.isString()"
              },
              "original_task": {},
              "attempts": {
                ".validate": "newData.isNumber() && newData.val() > 0"
              },
              "$other": {
                ".validate": false
              }
          },
          "_id": {
            ".validate": "newData.isString()"
          },
        },
      },

      "specs" : {
        ".read": "auth.worldmaster === true",
        ".write": "auth.worldmaster === true",
        "$specId": {
          ".validate": "newData.hasChild('in_progress_state')",
          "start_state":       { ".validate": "newData.isString()" },
          "in_progress_state": { ".validate": "newData.isString()" },
          "finished_state":    { ".validate": "newData.isString()" },
          "error_state":       { ".validate": "newData.isString()" },
          "timeout":           { ".validate": "newData.isNumber() && newData.val() > 0" },
          "$other":            { ".validate": false },
        },
      },
    },

  },
}
